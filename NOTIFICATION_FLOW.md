# Push Notification Flow Diagram

## ๐ฑ Complete Notification Flow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         CUSTOMER BOOKS APPOINTMENT                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Frontend (Customer)                                                     โ
โ  POST /api/bookings                                                      โ
โ  - Customer name, phone, email                                           โ
โ  - Service, date, time                                                   โ
โ  - Barber ID                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Backend - bookingController.js                                          โ
โ  1. Validate booking data                                                โ
โ  2. Check for conflicts                                                  โ
โ  3. Create booking in database                                           โ
โ  4. Send response to customer (201 Created)                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Background Tasks (async, doesn't block response)                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโ                  โ
โ  โ Send Email           โ    โ Send Push            โ                  โ
โ  โ to Barber            โ    โ Notification         โ                  โ
โ  โ (via Resend API)     โ    โ (via web-push)       โ                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโ                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  pushNotificationController.js                                           โ
โ  sendPushToBarber(barberId, payload)                                     โ
โ  1. Find all subscriptions for this barber                               โ
โ  2. Loop through each device/subscription                                โ
โ  3. Send push notification via web-push library                          โ
โ  4. Handle failures (remove invalid subscriptions)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Web Push Protocol (HTTPS)                                               โ
โ  Browser Push Service (Google FCM / Mozilla / Apple)                     โ
โ  - Routes notification to correct device                                 โ
โ  - Wakes up service worker if needed                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Barber's Device - Service Worker (service-worker.js)                    โ
โ  1. Receives push event                                                  โ
โ  2. Parses notification data                                             โ
โ  3. Shows notification to barber                                         โ
โ     - Title: "๐ New Booking!"                                           โ
โ     - Body: "John Doe booked Haircut on 2026-02-03 at 2:00 PM"          โ
โ     - Icon: /favicon.png                                                 โ
โ     - Actions: [View, Close]                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Barber Clicks Notification                                              โ
โ  - Service worker catches 'notificationclick' event                      โ
โ  - Opens /barber/bookings page                                           โ
โ  - Focuses existing tab if already open                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Initial Setup Flow (One-time per device)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Barber Logs In                                                          โ
โ  POST /api/barber-auth/login                                             โ
โ  - Receives JWT token                                                    โ
โ  - Token stored in localStorage                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Barber Dashboard Loads                                                  โ
โ  <NotificationPermission /> component renders                            โ
โ  - Checks if notifications are supported                                 โ
โ  - Checks current subscription status                                    โ
โ  - Checks notification permission status                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  IF NOT SUBSCRIBED: Shows yellow prompt                                  โ
โ  "Enable Push Notifications"                                             โ
โ  "Get instant alerts when customers book appointments..."                โ
โ  [Enable Notifications] button                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Barber Clicks "Enable Notifications"                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Frontend - pushNotifications.js                                         โ
โ  1. Request notification permission from browser                         โ
โ  2. Wait for user to allow/deny                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Browser Shows Permission Dialog                                         โ
โ  "salonabed.hair wants to send you notifications"                        โ
โ  [Block] [Allow]                                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  IF ALLOWED: Continue subscription process                               โ
โ  1. Get VAPID public key from server                                     โ
โ     GET /api/push/vapid-public-key                                       โ
โ  2. Convert key to Uint8Array format                                     โ
โ  3. Subscribe via pushManager.subscribe()                                โ
โ  4. Get subscription object with endpoint and keys                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Send Subscription to Backend                                            โ
โ  POST /api/push/subscribe                                                โ
โ  Headers: { Authorization: "Bearer <barber-token>" }                     โ
โ  Body: {                                                                 โ
โ    subscription: {                                                       โ
โ      endpoint: "https://fcm.googleapis.com/...",                         โ
โ      keys: { p256dh: "...", auth: "..." }                               โ
โ    }                                                                     โ
โ  }                                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Backend - pushNotificationController.js                                 โ
โ  subscribe() function                                                    โ
โ  1. Verify barber authentication (JWT)                                   โ
โ  2. Get barber ID from admin account                                     โ
โ  3. Check if subscription exists                                         โ
โ     - If yes: Update keys                                                โ
โ     - If no: Create new subscription                                     โ
โ  4. Save to PushSubscription collection                                  โ
โ  5. Return success response                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Frontend Updates UI                                                     โ
โ  Shows green success message:                                            โ
โ  "โ Notifications Enabled"                                              โ
โ  "You'll receive push notifications for new bookings..."                 โ
โ  [Disable notifications]                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐๏ธ Database Schema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PushSubscription Collection                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  {                                                                       โ
โ    _id: ObjectId,                                                        โ
โ    barberId: ObjectId (ref: 'Barber'),                                   โ
โ    endpoint: String (unique),                                            โ
โ    keys: {                                                               โ
โ      p256dh: String,                                                     โ
โ      auth: String                                                        โ
โ    },                                                                    โ
โ    userAgent: String,                                                    โ
โ    createdAt: Date,                                                      โ
โ    updatedAt: Date                                                       โ
โ  }                                                                       โ
โ                                                                          โ
โ  Indexes:                                                                โ
โ  - { barberId: 1, endpoint: 1 } (unique)                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Security Flow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  VAPID Authentication                                                    โ
โ  - Public key: Shared with frontend (safe to expose)                    โ
โ  - Private key: Kept secret on backend (never exposed)                  โ
โ  - Used to sign push messages                                           โ
โ  - Proves message came from legitimate server                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  JWT Authentication                                                      โ
โ  - Only authenticated barbers can subscribe                              โ
โ  - protectBarber middleware checks JWT                                   โ
โ  - Links subscription to correct barber account                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Browser Security                                                        โ
โ  - User must explicitly grant permission                                 โ
โ  - Service worker must be HTTPS (except localhost)                       โ
โ  - Same-origin policy applies                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Multi-Device Support

```
One Barber Account
    โ
    โโโ Device 1 (Desktop Chrome)
    โ   โโโ Subscription 1 โ endpoint_1, keys_1
    โ
    โโโ Device 2 (Mobile Chrome)
    โ   โโโ Subscription 2 โ endpoint_2, keys_2
    โ
    โโโ Device 3 (Tablet Firefox)
        โโโ Subscription 3 โ endpoint_3, keys_3

When booking is created:
โ Backend finds all 3 subscriptions
โ Sends push to all 3 devices
โ Barber receives notification on all active devices
```

## ๐งน Automatic Cleanup

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  When Push Fails (410 or 404 error)                                     โ
โ  - Subscription no longer valid                                          โ
โ  - Device uninstalled app / cleared data                                 โ
โ  - Browser unregistered push subscription                                โ
โ                                                                          โ
โ  Action:                                                                 โ
โ  โ Automatically delete subscription from database                       โ
โ  โ Prevents sending to invalid endpoints                                 โ
โ  โ Keeps database clean                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ฏ Notification Payload Structure

```javascript
{
  title: "๐ New Booking!",
  body: "John Doe booked Haircut on 2026-02-03 at 2:00 PM",
  icon: "/favicon.png",
  badge: "/favicon.png",
  data: {
    bookingId: "65abc123...",
    customerName: "John Doe",
    customerPhone: "+961 123 456 789",
    serviceName: "Haircut",
    date: "2026-02-03",
    time: "2:00 PM",
    price: 25,
    url: "/barber/bookings"
  }
}
```

---

**Note**: This flow diagram shows the complete end-to-end process from booking creation to notification delivery. All steps happen automatically once the barber has enabled notifications on their device.
